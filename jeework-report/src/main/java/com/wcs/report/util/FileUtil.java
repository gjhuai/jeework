package com.wcs.report.util;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.Serializable;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import javax.ejb.Stateless;
import javax.faces.context.FacesContext;
import javax.servlet.http.HttpServletRequest;

/**
 * 
 * <p>
 * Project: cmdpms
 * </p>
 * <p>
 * Description: 文件上传工具类
 * </p>
 * <p>
 * Copyright (c) 2011 Wilmar Consultancy Services
 * </p>
 * <p>
 * All Rights Reserved.
 * </p>
 * 
 * @author <a href="mailto:chenlong@wcs-global.com">chenlong</a>
 */
public class FileUtil implements Serializable {

    /**
	 *                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
	 */
    private static final long serialVersionUID = 1L;
    public static final String FLODER_NAME = "upload"+File.separator+"rpt";

    /**
     * 
     * <p>
     * Description: 得到项目部署绝对路径
     * </p>
     * 
     * @return
     */
    public static  String  getProjectAbsolute() {
        HttpServletRequest request = (HttpServletRequest) FacesContext.getCurrentInstance().getExternalContext()
                .getRequest();
        String projectPath = request.getSession().getServletContext().getRealPath(File.separator).replace("btcbase.war", FLODER_NAME);
        return projectPath.substring(0, projectPath.length()-1);
    }

    /**
     * 
     * <p>
     * Description: 根据URL创建文件
     * </p>
     * 
     * @param fileUrl
     */
    public static File createFile(String fileName, String floder) throws Exception {
        boolean floderflag = hasFileDirectoryByUrl(floder);
        String path = null;
        String projectpath = getProjectAbsolute();
        if (floderflag && getDateFolder().equals(floder)) {
            path = projectpath.concat(floder).concat(File.separator).concat(fileName);
        } else {
            File argfloder = new File(projectpath.concat(getDateFolder()));
            argfloder.mkdir();
            path = projectpath.concat(getDateFolder()).concat(File.separator).concat(fileName);
        }
        File file = new File(path);
        if (file != null && !file.exists()) {
            file.createNewFile();
        }
        return file;
    }

    /**
     * 
     * <p>
     * Description: 是否存在文件
     * </p>
     * 
     * @param fileName
     * @param directory
     * @return
     * @throws Exception
     */
    public  static boolean isExistFile(String fileName, String directory) throws Exception {
        List<File> dirFileList = findFileByDirecoty(directory);
        for (File file : dirFileList) {
            if (file.getName().equals(fileName)) {
                return true;
            }
        }
        return false;
    }

    /**
     * 
     * <p>
     * Description: 删除文件
     * </p>
     * 
     * @param fileUrl
     */
    public static void  deleteFile(String fileName, String directory) throws Exception {
        boolean flag = hasFileDirectoryByUrl(directory);
        String path = null;
        String projectPath = getProjectAbsolute();
        if (flag) {
            path = projectPath.concat(directory).concat(File.separator).concat(fileName);
            File file = new File(path);
            if (file != null && file.exists()) {
                file.delete();
            }
        }
    }

    /**
     * 
     * <p>
     * Description: 指定文件夹是否存在
     * </p>
     * 
     * @param fileUrl
     * @param fileName
     * @return
     */
    public static boolean hasFileDirectoryByUrl(String fileUrl) throws Exception {
        if (fileUrl == null) {
            return false;
        }
        File file = getDirectoryFile(fileUrl);
        if (file != null) {
            return true;
        }
        return false;
    }

    /**
     * 
     * <p>
     * Description: 返回指定目录下的所有文件
     * </p>
     * 
     * @param directory
     * @return
     * @throws Exception
     */
    private static List<File> findFileByDirecoty(String directory) throws Exception {
        File directoryfile = getDirectoryFile(directory);
        List<File> fileList = new ArrayList<File>();
        if (directoryfile != null && directoryfile.isDirectory()) {
            File[] fileArray = directoryfile.listFiles();
            for (File file : fileArray) {
                if (file.isFile()) {
                    fileList.add(file);
                }
            }
        }
        return fileList;
    }

    /**
     * 
     * <p>
     * Description: 得到文件目录对象
     * </p>
     * 
     * @param fileUrl
     * @return
     * @throws Exception
     */
    private  static File getDirectoryFile(String fileUrl) throws Exception {
        File directory = new File(getProjectAbsolute() + fileUrl);
        if (directory != null && directory.isDirectory()) {
            return directory;
        } else {
            return null;
        }
    }

    /**
     * 
     * <p>
     * Description: 得到日期文建夹字符串
     * </p>
     * 
     * @return
     * @throws Exception
     */
    private static String getDateFolder() throws Exception {
        Date date = new Date();
        SimpleDateFormat simple = new SimpleDateFormat("yyyy-MM-dd");
        String url = simple.format(date).toString();
        return url;
    }
    
    /**
     * 
     * <p>
     * Description: 将上传文件写到服务器文件
     * </p>
     * 
     * @param sourcefile
     * @param tagerFile
     * @throws IOException
     */
    public  static void readFile(InputStream input, File tagerFile) throws IOException {
        if (tagerFile == null || input == null) {
            return;
        }
        FileOutputStream out = new FileOutputStream(tagerFile);
        int index = 0;
        byte[] filebyte = new byte[1024];
        while ((index = input.read(filebyte, 0, filebyte.length)) != -1) {
            out.write(filebyte,0,index);
        }
        input.close();
        out.close();
    }
}
